<!doctype html>
<html>
	<head>
		<title>weather_station</title>		
		<link rel="stylesheet" type="text/css" href="/static/stylesheets/style.css">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	</head>
	<body>
		<h1>Weather Station</h1>
		<status id="connbull">&#x25cf;</status><status id="conntext"></status>
		<table>
			<tr>
				<div id="container"></div>
			</tr>
			<tr>
				<td>temperature: </td>
				<td align="right" style="width:4em"><data id="temp"></data></td>
				<td>&#8451;</td>
			</tr>
			<tr>
				<td>atmospheric pressure: </td>
				<td align="right" style="width:4em"><data id="atm"></data></td>
				<td>hPa</td>
			</tr>
		</table>
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="https://code.highcharts.com/stock/highstock.js"></script>
		<script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
		<script type="text/javascript" src="/static/javascripts/chartSettings.js"></script>
		<script type="text/javascript" src="/static/javascripts/connectionStatus.js"></script>
		<script>
			var socket = io();
			var chart;
			var time;
			
			socket.on('atm', function(a)
			{
				$('#atm').text(a[1]/100);
				/*
				try
				{
					chart.series[0].addPoint([a[0], a[1]/100], true, true);
				}
				catch(err)
				{
					console.log(err);
				}
				*/
			});
			socket.on('temp', function(t)
			{
				$('#temp').text(t[1]);
				/*
				try
				{
					chart.series[1].addPoint([t[0], t[1]], true, true);
				}
				catch(err)
				{ }
				*/
			});
			
			var q = { q: 'SELECT time,value FROM temp,atm' };
			function queryData()
			{
				$.get('query', q, function(influxData)
				{
					var seriesOptions = [];
					//convert Pa to hPa
					transformData(influxData, 0).map(function(obj)
					{
						obj[1] = obj[1] / 100;
						return obj;
					});
					seriesOptions[0] = 
					{
						color: Highcharts.getOptions().colors[1],
						name: 'Pressure',
						data: transformData(influxData, 0),
						yAxis: 0
					};
					seriesOptions[1] = 
					{
						color: Highcharts.getOptions().colors[0],
						name: 'Temperature',
						data: transformData(influxData, 1),
						yAxis: 1
					};
					chartSettings.series = seriesOptions;
					chart = new Highcharts.StockChart( chartSettings );
				});
			}
			function transformData(influxData, i)
			{
				return influxData.results[0].series[i].values;
			}
		</script>
	</body>
</html>