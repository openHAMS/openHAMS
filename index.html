<!doctype html>
<html>
  <head>
    <title>weather_station</title>
    <style>
      @import url(//fonts.googleapis.com/css?family=Roboto:400,300&subset=latin,latin-ext);
      * { box-sizing: border-box; }
      body { background-color: #FAFAFA; font-family: 'Roboto', sans-serif; font-size: 1.5em; font-weight: 300; }
      table { margin-top: 0.67em; }
      h1 { color: #2196F3; font-size: 2em; font-weight: 300; margin-bottom: -0.17em; }
      data { font-weight: 400; }
      status { font-size: 0.67em; font-weight: 400; margin-left: 0.33em; }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  </head>
  <body>
    <h1>Weather Station</h1>
    <status>&#x25cf;</status><status id="connection"></status>
    <table>
	  <tr>
	    <div id="container" style="width:100%; height:20em;"></div>
	  </tr>
      <tr>
        <td>temperature: </td>
        <td align="right" style="width:4em"><data id="temp"></data></td>
        <td>&#8451;</td>
      </tr>
      <tr>
        <td>atmospheric pressure: </td>
        <td align="right" style="width:4em"><data id="atm"></data></td>
        <td>hPa</td>
      </tr>
	  <tr>
	    <td id=lol></td>
	  </tr>
    </table>
    <script src="https://code.jquery.com/jquery-3.0.0.js"></script>
	<script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script>
      var socket = io();
      socket.on('connect', function()
      {
        $('status').css('color', '#4CAF50');
        $('#connection').text('Connected');
      });
      socket.on('connect_error', function()
      {
        $('status').css('color', '#FF5722');
        $('#connection').text('Disconnected.');
      });
      socket.on('reconnect_attempt', function()
      {
        $('status').css('color', '#FFC107');
        $('#connection').text('Reconnecting...');
      });
      socket.on('temp', function(t)
      {
        $('#temp').text(t);
      });
      socket.on('atm', function(a)
      {
        $('#atm').text(a/100);
      });
	  var influxdb = 'http://racerzeroone.ddns.net:8086/query';
	  var testQuery = "SELECT time,value FROM temp";
      $.getJSON( influxdb,
	    {
		  u: 'public',
		  p: 'public',
          db: 'mydb',
		  epoch: 'ms',
          q: testQuery
        },
        function( influxData )
	    {
		  $('#container').highcharts('StockChart',
		  {
		    rangeSelector:
			{ 
			  allButtonsEnabled: true,
			  buttons: 
			  [
			    {
				  type: 'minute',
				  count: 60,
				  text: 'hour'
				},
				{
				  type: 'day',
				  count: 1,
				  text: 'day'
				},
				{
				  type: 'week',
				  count: 1,
				  text: 'week'
				},
				{
				  type: 'all',
				  text: 'All'
				}
			  ],
			  selected: 0
			},
			xAxis: { ordinal: false },
			series:
			[
			  {
			    name: 'Temperature',
			    data: transformData(influxData)
			  }
			]
		  });
		  var asd = JSON.stringify(transformData(influxData));
        });
	  function transformData(influxData)
	  {
        return influxData.results[0].series[0].values;
      }
    </script>
  </body>
</html>